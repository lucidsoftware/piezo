name: CI
on:
  pull_request:
  push:
    branches:
      - master
    tags:
      - "*.*.*"

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Startup MySQL service
        run: sudo /etc/init.d/mysql start
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: sbt
      - uses: sbt/setup-sbt@v1
      - name: Set Env
        if: ${{ github.repository == 'lucidsoftware/piezo' }}
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            version="${GITHUB_REF#refs/tags/}"
          else
            version="${GITHUB_REF##*/}-SNAPSHOT"
          fi
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "SBT_OPTS=-Dbuild.version=$version" >> $GITHUB_ENV
      - name: Test
        run: sbt compile test scalafmtCheck doc Debian/packageBin
      - name: Publish to Sonatype
        if: ${{ github.repository == 'lucidsoftware/piezo'  &&  github.event_name != 'pull_request' }}
        env:
          PGP_SECRET: ${{ secrets.PGP_SECRET }}
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        run: sbt ci-release
      # TODO: publish deb somewhere?
      - name: Upload assets to Github
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x
          sbt Universal/packageBin
          gh release create -t "Release $VERSION" --generate-notes $VERSION {admin,worker}/target/**/*.jar admin/target/*.deb admin/target/universal/piezo-admin*.zip
